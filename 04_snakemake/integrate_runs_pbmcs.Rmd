-------------------------------------------------------------------------------
title: "Across samples report"
author: "Izaskun Mallona at Robinsonlab"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: kable
    theme: lumen
    always_allow_html: yes
params:
  chromium1: ""
  chromium2: ""
  chromium3: ""
  smartseq1: ""
---


Rendered for samples:

```{r}
print(params)
```
# Config

```{r}
suppressPackageStartupMessages({
library(Matrix)

library(knitr)
library(Seurat)
## library(dplyr)
## library(scater)
library(data.table)
## library(SingleCellExperiment)
## library(scran)
## library(org.Mm.eg.db)
## suppressPackageStartupMessages(library(dplyr))
## suppressPackageStartupMessages(library(DT))
library(pheatmap)
## library(Cairo)
## library(RColorBrewer)
## library(corrplot)
library(ggplot2)
library(reshape2)
## library(xtable)
## library(mclust)
library(viridis)
library(UpSetR)
})
```

```{r}
BASE <- file.path('/home', 'imallona', 'repeats_sc')
```

```{r}
opts_chunk$set(fig.width = 5,
               fig.height = 5,
               dev = 'png',
               cache = FALSE,
               echo = TRUE,
               include = TRUE,
               cache.lazy = FALSE,
               warning = TRUE,
               error = TRUE,
               message = FALSE)


options(bitmapType='cairo')
## getOption('bitmapType')
```


```{r functions}
## add alpha
ac <- function(col, alpha=1){
  apply(sapply(col, col2rgb)/255, 2, 
                     function(x) 
                       rgb(x[1], x[2], x[3], alpha=alpha))  
}

load_standard_cellranger_genes <- function(run_name) {
    ## barcodes_fn <- params$genes_cellranger ## should end with `barcodes.tsv.gz`
    barcodes_fn <- file.path(BASE, 'runs', run_name, 'cellranger_standard', 'outs',
                             'filtered_feature_bc_matrix', 'barcodes.tsv.gz')
    
    path <- dirname(barcodes_fn)

    genes <- CreateSeuratObject(counts = Read10X(data.dir = path),
                                project = 'cellranger_standard',
                                min.cells = 0,
                                min.features = 0)
    return(genes)
}

load_cellranger_repeats <-  function(run_name) {
    barcodes_fn <- file.path(BASE, 'runs', run_name, 'cellranger_repeats', 'outs',
                             'filtered_feature_bc_matrix', 'barcodes.tsv.gz')

    path <- dirname(barcodes_fn)

    repeats <- CreateSeuratObject(counts = Read10X(data.dir = path),
                                project = 'cellranger_repeats',
                                min.cells = 0,
                                min.features = 0)
    return(repeats)
}

load_featurecounts_repeats <-  function(run_name) {

    repeats <- file.path(BASE, "runs", run_name, 'count_repeats_on_cellranger_standard',
                                paste0(run_name, "_repeats.counts.gz"))

    tmp <- data.table::fread(repeats, sep = '\t', header = TRUE,
                             drop = c('Chr', 'Start', 'End', 'Strand', 'Length'))
    rownames(tmp) <- tmp$Geneid ## here

    colnames(tmp) <- gsub(".*:([A-Z]+)-1.bam","\\1", colnames(tmp))

    tmp <- as.data.frame(tmp)
    rownames(tmp) <- tmp$Geneid
    tmp <- tmp[,-1]

    featurecounts <- CreateSeuratObject(
        tmp,
        project = "seurat",
        assay = "RNA",
        min.cells = 0,
        min.features = 0,
        names.field = 1,
        names.delim = "_",
        meta.data = NULL)

    return(featurecounts)
}

coef_var <- function(x){
        (sd(x)/mean(x))*100
}


```

# Data load Seurat objects

```{r justfordebugging, eval = FALSE}
## params <- list(genes_cellranger = "/home/imallona/repeats_sc/runs/frozen_pbmc_donor_a/cellranger_standard/outs/filtered_feature_bc_matrix/barcodes.tsv.gz",
##                repeats_cellranger= "/home/imallona/repeats_sc/runs/frozen_pbmc_donor_a/cellranger_repeats/outs/filtered_feature_bc_matrix/barcodes.tsv.gz",
##                repeats_featurecounts= "/home/imallona/repeats_sc/runs/frozen_pbmc_donor_a/count_repeats_on_cellranger_standard/frozen_pbmc_donor_a_repeats.counts.gz")

## SRR10974769

## params <- list(run1 = '/home/imallona/repeats_sc/runs/SRR10974769/SRR10974769_pmbc_cellranger_regress_nCount_FALSE_nFeature_FALSE.rds',
##                run2 = '/home/imallona/repeats_sc/runs/5k_pbmc_v3/5k_pbmc_v3_pmbc_cellranger_regress_nCount_FALSE_nFeature_FALSE.rds',
##                run3 = '/home/imallona/repeats_sc/runs/frozen_pbmc_donor_a/frozen_pbmc_donor_a/summarize_cellranger_run_regress_nCount_FALSE_nFeature_FALSE.rds',
##                run4 = '/home/imallona/repeats_sc/runs/5k_pbmc_v3/5k_pbmc_v3_pmbc_cellranger_regress_nCount_FALSE_nFeature_FALSE.rds')

params <- list( chromium1 = '/home/imallona/repeats_sc/runs/frozen_pbmc_donor_a/frozen_pbmc_donor_a_pmbc_cellranger_regress_nCount_FALSE_nFeature_FALSE.rds',
        chromium2 = '/home/imallona/repeats_sc/runs/5k_pbmc_v3/5k_pbmc_v3_pmbc_cellranger_regress_nCount_FALSE_nFeature_FALSE.rds',
        chromium3 = '/home/imallona/repeats_sc/runs/pbmc_10k_v3/pbmc_10k_v3_pmbc_cellranger_regress_nCount_FALSE_nFeature_FALSE.rds',
        smartseq1 = '/home/imallona/repeats_sc/runs/pbmcs_smartseq2_ding/pbmcs_smartseq2_ding_pmbc_smartseq2_regress_nCount_FALSE_nFeature_FALSE.rds')
```


```{r}
d <- list()
```

```{r}
## cr cellranger
## fc featurecounts
for (rds in params) {
    
    ## d[[run]] <- list()
    ## d[[run]]$genes_cr <- load_standard_cellranger_genes(run_name = run)
    ## d[[run]]$reps_cr <- load_cellranger_repeats(run_name = run)
    ## d[[run]]$reps_fc <- load_featurecounts_repeats(run_name = run)
    d[[sapply(strsplit(dirname(rds), .Platform$file.sep),
               function(x) return(x[6]))]] <- readRDS(file = rds)
}
```

# Most variable repeats cellranger {.tabset}

Similarly for repeats expression (avg +- sd of repeats CPM by gene expression cluster?)


```{r, fig.height = 5, fig.width = 15, results = 'asis'}
res <- 'RNA_snn_res.0.2'

## ## selected <- c('AluY', 'AluSx', 'MER49', 'MIR', 'L2a', 'L2b', 'L1PA11')
## selected <- c(names(head(sort(apply(GetAssayData(d[[run]]$repeats_cellranger),1, coef_var), decreasing = TRUE),
##                          5)), c('AluY', 'AluSx', 'L1PA11', 'MIR', 'L2a'))

## maybe with variable features?

for (run in names(d)[sapply(d, function(x) return('repeats_cellranger' %in% names(x)))]) {
    cat("## ", run, "\n\n")
    repeats_cellranger <- as.data.frame(FetchData(
        d[[run]]$repeats_cellranger,
        vars = head(VariableFeatures(d[[run]]$repeats_cellranger), 10) , slot = 'data'))
        
    repeats_cellranger$cell <- rownames(repeats_cellranger)
        
    d[[run]]$genes@meta.data$cell <- rownames(d[[run]]$genes@meta.data)
    repeats_cellranger <- merge(d[[run]]$genes@meta.data[, c(res, 'cell') ],
                     repeats_cellranger, by = 'cell', all.x = TRUE)
    
    rownames(repeats_cellranger) <- repeats_cellranger$cell
    
    repeats_cellranger <- melt(repeats_cellranger, id.vars = c('cell', res))
    
    colnames(repeats_cellranger) <- c('cell', res, 'repfamily', 'CPM')

    print(ggplot(repeats_cellranger,
           aes(x = get(res), y = CPM)) + 
          geom_boxplot(outlier.size=1) +
          scale_y_continuous(trans='log10') +
        scale_fill_discrete(drop=FALSE) +
        facet_wrap(~ factor(repfamily), ncol = 10) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        ylab('repeat expression [CPM]') +
        xlab('gene-based clustering') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_cellranger', res)))
    cat('\n\n')
}

```

# Most variable repeats cellranger by identity {.tabset}


```{r, fig.height = 5, fig.width = 15, results = 'asis'}
scina <- 'scina'
## agg <- list()

for (run in names(d)[sapply(d, function(x) return('repeats_cellranger' %in% names(x)))]) {
    cat("## ", run, "\n\n")
    
    repeats_cellranger <- as.data.frame(FetchData(
        d[[run]]$repeats_cellranger,
        vars = head(VariableFeatures(d[[run]]$repeats_cellranger), 10) , slot = 'data'))


    
    repeats_cellranger$cell <- rownames(repeats_cellranger)

    d[[run]]$genes@meta.data$cell <- rownames(d[[run]]$genes@meta.data)
    repeats_cellranger <- merge(d[[run]]$genes@meta.data[, c(scina, 'cell') ],
                     repeats_cellranger, by = 'cell', all.x = TRUE)
    
    rownames(repeats_cellranger) <- repeats_cellranger$cell
    
    repeats_cellranger <- melt(repeats_cellranger, id.vars = c('cell', scina))
    
    colnames(repeats_cellranger) <- c('cell', scina, 'repfamily', 'CPM')

    print(ggplot(repeats_cellranger,
           aes(x = scina, y = CPM)) + 
          geom_boxplot(outlier.size=1) +
          scale_y_continuous(trans='log10') +
        scale_fill_discrete(drop=FALSE) +
        facet_wrap(~ factor(repfamily), ncol = 10) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        ylab('repeat expresssion [CPM]') +
        xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_cellranger', scina)))
    cat('\n\n')

}

```

# All integrated (repeats, scina)

```{r fig.width = 14, fig.height = 14}

## first aggregate all repeats_cellranger stuff
sds <- lapply(d[sapply(d, function(x) return('repeats_cellranger' %in% names(x)))],
              function(x) return(apply(as.data.frame(GetAssayData(x$repeats_cellranger,
                                                        slot = 'data')), 1, sd)))

## get the ones with the highest average sd

mean_sd <- apply(do.call(cbind.data.frame, sds), 1, mean)
selected <- names(head(sort(mean_sd, decreasing = TRUE), 20))
## selected


## aggregate(agg['CPM'], by = list(agg$repfamily, agg$run),  FUN = function(x) c(mean = mean(x, na.rm = TRUE), n = length(x), sd = sd(x, na.rm = TRUE) ))

## now get these data for selected features, aggregate and plot

tmp <- list()
for (run in names(d)) {
    foo <- data.frame(run = run,
                             FetchData(d[[run]]$repeats_cellranger, vars = selected, slot = 'data'))

    ## add annotations
    bar <- data.frame(cell = rownames(foo),
                      scina = d[[run]]$repeats_cellranger@meta.data[rownames(foo), 'scina'])

    stopifnot(rownames(foo) == bar$cell)
    
    
    tmp[[run]] <- data.frame(foo, scina = bar$scina)
    rm(foo, bar)
}

tmp <- do.call(rbind.data.frame, tmp)
str(tmp)

## melt
repeats_cellranger <- melt(tmp, id.vars = c('run', 'scina'))
head(repeats_cellranger)    
colnames(repeats_cellranger) <- c('run', 'scina', 'repfamily', 'CPM')

```

```{r, fig.width = 12, fig.height = 12}
print(ggplot(repeats_cellranger,
             aes(x = scina, y = CPM, fill = run)) + 
      geom_boxplot(outlier.size=1) +
      scale_y_continuous(trans='log10') +
      scale_fill_discrete(drop=FALSE) +
      facet_wrap(~ factor(repfamily), ncol = 4) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ylab('repeat expresssion [CPM]') +
      xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_cellranger', scina)))
```


```{r, fig.width = 8, fig.height = 14}
print(ggplot(repeats_cellranger,
             aes(x = repfamily, y = CPM, fill = run)) + 
      geom_boxplot(outlier.size=1) +
      scale_y_continuous(trans='log10') +
      scale_fill_discrete(drop=FALSE) +
      facet_grid(factor(scina)~ factor(run)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ylab('repeat expresssion [CPM]') +
      xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_cellranger', scina)))




```

# Cluster by average expression (repeats, SCINA)

Avoiding non-determined cell types

```{r, results = 'asis', fig.height = 10, fig.width = 10}
repeats_cellranger <- repeats_cellranger[repeats_cellranger$scina != 'unknown',]
foo <- reshape2::dcast(repeats_cellranger, run + scina ~ repfamily, mean, value.var = 'CPM')


rownames(foo) <- paste(foo$run, foo$scina, sep = '_')

annot <- foo[,c('run', 'scina')]
rownames(annot) <- paste(annot$run, annot$scina, sep = '_')
foo <- foo[,-(1:2)]

pheatmap(foo, annotation_row = annot, show_rownames = FALSE)

pheatmap(t(foo), annotation_col = annot, show_colnames = FALSE)


```



<!-- here start -->


# Most variable repeats star {.tabset}

Similarly for repeats expression (avg +- sd of repeats CPM by gene expression cluster?)

What's the point here?


```{r, fig.height = 5, fig.width = 15, results = 'asis'}
res <- 'RNA_snn_res.0.2'

## ## selected <- c('AluY', 'AluSx', 'MER49', 'MIR', 'L2a', 'L2b', 'L1PA11')
## selected <- c(names(head(sort(apply(GetAssayData(d[[run]]$repeats_star),1, coef_var), decreasing = TRUE),
##                          5)), c('AluY', 'AluSx', 'L1PA11', 'MIR', 'L2a'))

## maybe with variable features?

for (run in names(d)[sapply(d, function(x) return('repeats_star' %in% names(x)))]) {
    cat("## ", run, "\n\n")
    repeats_star <- as.data.frame(FetchData(
        d[[run]]$repeats_star,
        vars = head(VariableFeatures(d[[run]]$repeats_star), 10) , slot = 'data'))
        
    repeats_star$cell <- rownames(repeats_star)
        
    d[[run]]$genes@meta.data$cell <- rownames(d[[run]]$genes@meta.data)
    repeats_star <- merge(d[[run]]$genes@meta.data[, c(res, 'cell') ],
                     repeats_star, by = 'cell', all.x = TRUE)
    
    rownames(repeats_star) <- repeats_star$cell
    
    repeats_star <- melt(repeats_star, id.vars = c('cell', res))
    
    colnames(repeats_star) <- c('cell', res, 'repfamily', 'CPM')

    print(ggplot(repeats_star,
           aes(x = get(res), y = CPM)) + 
          geom_boxplot(outlier.size=1) +
          scale_y_continuous(trans='log10') +
        scale_fill_discrete(drop=FALSE) +
        facet_wrap(~ factor(repfamily), ncol = 10) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        ylab('repeat expression [CPM]') +
        xlab('gene-based clustering') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_star', res)))
    cat('\n\n')
}

```

# Most variable repeats star by identity {.tabset}


```{r, fig.height = 5, fig.width = 15, results = 'asis'}
scina <- 'scina'
## agg <- list()

for (run in names(d)[sapply(d, function(x) return('repeats_star' %in% names(x)))]) {
    cat("## ", run, "\n\n")
    
    repeats_star <- as.data.frame(FetchData(
        d[[run]]$repeats_star,
        vars = head(VariableFeatures(d[[run]]$repeats_star), 10) , slot = 'data'))


    
    repeats_star$cell <- rownames(repeats_star)

    d[[run]]$genes@meta.data$cell <- rownames(d[[run]]$genes@meta.data)
    repeats_star <- merge(d[[run]]$genes@meta.data[, c(scina, 'cell') ],
                     repeats_star, by = 'cell', all.x = TRUE)
    
    rownames(repeats_star) <- repeats_star$cell
    
    repeats_star <- melt(repeats_star, id.vars = c('cell', scina))
    
    colnames(repeats_star) <- c('cell', scina, 'repfamily', 'CPM')

    print(ggplot(repeats_star,
           aes(x = scina, y = CPM)) + 
          geom_boxplot(outlier.size=1) +
          scale_y_continuous(trans='log10') +
        scale_fill_discrete(drop=FALSE) +
        facet_wrap(~ factor(repfamily), ncol = 10) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        ylab('repeat expresssion [CPM]') +
        xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_star', scina)))
    cat('\n\n')

}

```

# All integrated (repeats, scina)

```{r fig.width = 14, fig.height = 14}

## first aggregate all repeats_star stuff
sds <- lapply(d[sapply(d, function(x) return('repeats_star' %in% names(x)))],
              function(x) return(apply(as.data.frame(GetAssayData(x$repeats_star,
                                                        slot = 'data')), 1, sd)))

## get the ones with the highest average sd

mean_sd <- apply(do.call(cbind.data.frame, sds), 1, mean)
selected <- names(head(sort(mean_sd, decreasing = TRUE), 20))
## selected


## aggregate(agg['CPM'], by = list(agg$repfamily, agg$run),  FUN = function(x) c(mean = mean(x, na.rm = TRUE), n = length(x), sd = sd(x, na.rm = TRUE) ))

## now get these data for selected features, aggregate and plot

tmp <- list()
for (run in names(d)) {
    foo <- data.frame(run = run,
                             FetchData(d[[run]]$repeats_star, vars = selected, slot = 'data'))

    ## add annotations
    bar <- data.frame(cell = rownames(foo),
                      scina = d[[run]]$repeats_star@meta.data[rownames(foo), 'scina'])

    stopifnot(rownames(foo) == bar$cell)
    
    
    tmp[[run]] <- data.frame(foo, scina = bar$scina)
    rm(foo, bar)
}

tmp <- do.call(rbind.data.frame, tmp)
str(tmp)

## melt
repeats_star <- melt(tmp, id.vars = c('run', 'scina'))
head(repeats_star)    
colnames(repeats_star) <- c('run', 'scina', 'repfamily', 'CPM')

```

```{r, fig.width = 12, fig.height = 12}
print(ggplot(repeats_star,
             aes(x = scina, y = CPM, fill = run)) + 
      geom_boxplot(outlier.size=1) +
      scale_y_continuous(trans='log10') +
      scale_fill_discrete(drop=FALSE) +
      facet_wrap(~ factor(repfamily), ncol = 4) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ylab('repeat expresssion [CPM]') +
      xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_star', scina)))
```


```{r, fig.width = 8, fig.height = 14}
print(ggplot(repeats_star,
             aes(x = repfamily, y = CPM, fill = run)) + 
      geom_boxplot(outlier.size=1) +
      scale_y_continuous(trans='log10') +
      scale_fill_discrete(drop=FALSE) +
      facet_grid(factor(scina)~ factor(run)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ylab('repeat expresssion [CPM]') +
      xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_star', scina)))

```

# Cluster by average expression (repeats, SCINA)

Avoiding non-determined cell types

```{r, results = 'asis', fig.height = 10, fig.width = 10}
repeats_star <- repeats_star[repeats_star$scina != 'unknown',]
foo <- reshape2::dcast(repeats_star, run + scina ~ repfamily, mean, value.var = 'CPM')


rownames(foo) <- paste(foo$run, foo$scina, sep = '_')

annot <- foo[,c('run', 'scina')]
rownames(annot) <- paste(annot$run, annot$scina, sep = '_')
foo <- foo[,-(1:2)]

pheatmap(foo, annotation_row = annot, show_rownames = FALSE)

pheatmap(t(foo), annotation_col = annot, show_colnames = FALSE)
```


<!-- here stop -->



# Most variable repeats featurecounts {.tabset}

Similarly for repeats expression (avg +- sd of repeats CPM by gene expression cluster?)

What's the point here?


```{r, fig.height = 5, fig.width = 15, results = 'asis'}
res <- 'RNA_snn_res.0.2'

## ## selected <- c('AluY', 'AluSx', 'MER49', 'MIR', 'L2a', 'L2b', 'L1PA11')
## selected <- c(names(head(sort(apply(GetAssayData(d[[run]]$repeats_featurecounts),1, coef_var), decreasing = TRUE),
##                          5)), c('AluY', 'AluSx', 'L1PA11', 'MIR', 'L2a'))

## maybe with variable features?

for (run in names(d)[sapply(d, function(x) return('repeats_featurecounts' %in% names(x)))]) {
    cat("## ", run, "\n\n")
    repeats_featurecounts <- as.data.frame(FetchData(
        d[[run]]$repeats_featurecounts,
        vars = head(VariableFeatures(d[[run]]$repeats_featurecounts), 10) , slot = 'data'))
        
    repeats_featurecounts$cell <- rownames(repeats_featurecounts)
        
    d[[run]]$genes@meta.data$cell <- rownames(d[[run]]$genes@meta.data)
    repeats_featurecounts <- merge(d[[run]]$genes@meta.data[, c(res, 'cell') ],
                     repeats_featurecounts, by = 'cell', all.x = TRUE)
    
    rownames(repeats_featurecounts) <- repeats_featurecounts$cell
    
    repeats_featurecounts <- melt(repeats_featurecounts, id.vars = c('cell', res))
    
    colnames(repeats_featurecounts) <- c('cell', res, 'repfamily', 'CPM')

    print(ggplot(repeats_featurecounts,
           aes(x = get(res), y = CPM)) + 
          geom_boxplot(outlier.size=1) +
          scale_y_continuous(trans='log10') +
        scale_fill_discrete(drop=FALSE) +
        facet_wrap(~ factor(repfamily), ncol = 10) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        ylab('repeat expression [CPM]') +
        xlab('gene-based clustering') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_featurecounts', res)))
    cat('\n\n')
}

```

# Most variable repeats featurecounts by identity {.tabset}


```{r, fig.height = 5, fig.width = 15, results = 'asis'}
scina <- 'scina'
## agg <- list()

for (run in names(d)[sapply(d, function(x) return('repeats_featurecounts' %in% names(x)))]) {
    cat("## ", run, "\n\n")
    
    repeats_featurecounts <- as.data.frame(FetchData(
        d[[run]]$repeats_featurecounts,
        vars = head(VariableFeatures(d[[run]]$repeats_featurecounts), 10) , slot = 'data'))


    
    repeats_featurecounts$cell <- rownames(repeats_featurecounts)

    d[[run]]$genes@meta.data$cell <- rownames(d[[run]]$genes@meta.data)
    repeats_featurecounts <- merge(d[[run]]$genes@meta.data[, c(scina, 'cell') ],
                     repeats_featurecounts, by = 'cell', all.x = TRUE)
    
    rownames(repeats_featurecounts) <- repeats_featurecounts$cell
    
    repeats_featurecounts <- melt(repeats_featurecounts, id.vars = c('cell', scina))
    
    colnames(repeats_featurecounts) <- c('cell', scina, 'repfamily', 'CPM')

    print(ggplot(repeats_featurecounts,
           aes(x = scina, y = CPM)) + 
          geom_boxplot(outlier.size=1) +
          scale_y_continuous(trans='log10') +
        scale_fill_discrete(drop=FALSE) +
        facet_wrap(~ factor(repfamily), ncol = 10) +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        ylab('repeat expresssion [CPM]') +
        xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_featurecounts', scina)))
    cat('\n\n')

}

```

# All integrated (repeats, scina)

```{r fig.width = 14, fig.height = 14}

## first aggregate all repeats_featurecounts stuff
sds <- lapply(d[sapply(d, function(x) return('repeats_featurecounts' %in% names(x)))],
              function(x) return(apply(as.data.frame(GetAssayData(x$repeats_featurecounts,
                                                        slot = 'data')), 1, sd)))

## get the ones with the highest average sd

mean_sd <- apply(do.call(cbind.data.frame, sds), 1, mean)
selected <- names(head(sort(mean_sd, decreasing = TRUE), 20))
## selected


## aggregate(agg['CPM'], by = list(agg$repfamily, agg$run),  FUN = function(x) c(mean = mean(x, na.rm = TRUE), n = length(x), sd = sd(x, na.rm = TRUE) ))

## now get these data for selected features, aggregate and plot

tmp <- list()
for (run in names(d)) {
    foo <- data.frame(run = run,
                             FetchData(d[[run]]$repeats_featurecounts, vars = selected, slot = 'data'))

    ## add annotations
    bar <- data.frame(cell = rownames(foo),
                      scina = d[[run]]$repeats_featurecounts@meta.data[rownames(foo), 'scina'])

    stopifnot(rownames(foo) == bar$cell)
    
    
    tmp[[run]] <- data.frame(foo, scina = bar$scina)
    rm(foo, bar)
}

tmp <- do.call(rbind.data.frame, tmp)
str(tmp)

## melt
repeats_featurecounts <- melt(tmp, id.vars = c('run', 'scina'))
head(repeats_featurecounts)    
colnames(repeats_featurecounts) <- c('run', 'scina', 'repfamily', 'CPM')

```

```{r, fig.width = 12, fig.height = 12}
print(ggplot(repeats_featurecounts,
             aes(x = scina, y = CPM, fill = run)) + 
      geom_boxplot(outlier.size=1) +
      scale_y_continuous(trans='log10') +
      scale_fill_discrete(drop=FALSE) +
      facet_wrap(~ factor(repfamily), ncol = 4) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ylab('repeat expresssion [CPM]') +
      xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_featurecounts', scina)))
```


```{r, fig.width = 8, fig.height = 14}
print(ggplot(repeats_featurecounts,
             aes(x = repfamily, y = CPM, fill = run)) + 
      geom_boxplot(outlier.size=1) +
      scale_y_continuous(trans='log10') +
      scale_fill_discrete(drop=FALSE) +
      facet_grid(factor(scina)~ factor(run)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ylab('repeat expresssion [CPM]') +
      xlab('scina identity') + ggtitle(sprintf('%s %s\n%s', run, 'repeats_featurecounts', scina)))

```

# Cluster by average expression (repeats, SCINA)

Avoiding non-determined cell types

```{r, results = 'asis', fig.height = 10, fig.width = 10}
repeats_featurecounts <- repeats_featurecounts[repeats_featurecounts$scina != 'unknown',]
foo <- reshape2::dcast(repeats_featurecounts, run + scina ~ repfamily, mean, value.var = 'CPM')


rownames(foo) <- paste(foo$run, foo$scina, sep = '_')

annot <- foo[,c('run', 'scina')]
rownames(annot) <- paste(annot$run, annot$scina, sep = '_')
foo <- foo[,-(1:2)]

pheatmap(foo, annotation_row = annot, show_rownames = FALSE)

pheatmap(t(foo), annotation_col = annot, show_colnames = FALSE)
```




# Pheatmaps

Note the cell sampling: same cells in all plots; `annotation_col` comes from genes' clustering.

```{r, results = 'asis', dpi=50, fig.width = 15, fig.height = 15}
NCELLS <- 1000
NFEATURES <- 500

## stop()
for (run in names(d)) {
    cat("## ", run, "{.tabset}\n\n")
    
    set.seed(654)
    idx_cell <- sample(colnames(GetAssayData(d[[run]][[1]])), NCELLS, replace = FALSE)
    
    for (item in names(d[[run]])) {
        cat("### ", item, "{.tabset}\n\n")

        set.seed(464)
        idx_feat <- sample(VariableFeatures(d[[run]][[item]]), NFEATURES, replace = FALSE)
        
        print(pheatmap(GetAssayData(
            object = subset(d[[run]][[item]],
                            features = idx_feat,
                            cells = intersect(idx_cell, colnames(GetAssayData(d[[run]][[item]])))),
            slot = 'scale.data'),
            main = sprintf('%s %s', run, item),
            color = viridis(100),
            cluster_rows = TRUE,
            cluster_cols = TRUE,
            show_rownames = FALSE,
            show_colnames = FALSE,
            clustering_distance_cols = "euclidean",
            clustering_method = "ward.D2",
            clustering_distance_rows = "euclidean",
            fontsize_row = 12,
            annotation_col = as.data.frame(d[[run]]$genes_cellranger@meta.data[idx_cell, c(res),
                                                                               drop = FALSE]),
            scale = "none"))
        cat('\n\n')
    }
    cat('\n\n')
}
```

Maybe add the markers of some celltypes on top?


# ARIS

## Data load

```{r}

aris_df <- NULL

for (rds in params) {
    ## the params are RDS objects from Seurat
    ## aris[[sapply(strsplit(dirname(rds), .Platform$file.sep),
    ##       function(x) return(x[6]))]] <- list()
    fns <- list.files(dirname(rds), pattern = 'aris.*rds')
    for (fn in fns) {
        curr_nest <- readRDS(file.path(dirname(rds), fn))
        ## curr <- do.call(function(x) rbind.data.frame(x, setNames = c('cat1' , 'cat2', 'ari')),
        ##                 curr_nest)
        ## aris_df <- NULL
        for (item in names(curr_nest)) {
            curr <- curr_nest[[item]]
            colnames(curr) <- c('set1', 'set2', 'ari')
            curr$origin <- item

            parsed <- strcapture(
                pattern = "aris_regress_nCount_(.*)_nFeature_(.*).rds",
                x = fn,
                proto = list(ncount = logical(), nfeature = logical()))
            
            curr$ncount_scaling <- parsed$ncount
            curr$nfeature_scaling <- parsed$nfeature
            
            curr$sample <- sapply(strsplit(dirname(rds), .Platform$file.sep),
                                  function(x) return(x[6]))
            aris_df <- rbind(aris_df, curr)

        }

        ## aris[[sapply(strsplit(dirname(rds), .Platform$file.sep),
        ##              function(x) return(x[6]))]][[basename(fn)]] <- curr_nest
    }
}

summary(aris_df)
rm(parsed, curr)
```

Extract resolutions and n

```{r}
parsed <- strcapture(
    pattern = "(.*)_RNA_snn_res.(.*) \\(n=(.*)\\)",
    x = aris_df$set1,
    proto = list(id1 = character(),
                 res1 = numeric(),
                 size1 = numeric()))

aris_df <- cbind(aris_df, parsed)
rm(parsed)

parsed <- strcapture(
    pattern = "(.*)_RNA_snn_res.(.*) \\(n=(.*)\\)",
    x = aris_df$set2,
    proto = list(id2 = character(),
                 res2 = numeric(),
                 size2 = numeric()))

aris_df <- cbind(aris_df, parsed)
rm(parsed)

## head(aris_df)
```




## ARIs comparison {.tabset}

Plot ARIs decay with resolution, scaling etc

```{r, fig.width=12, fig.height=8, results = 'asis'}

aris_df$regressed_out <- 'none'

aris_df$regressed_out[aris_df$ncount_scaling & aris_df$nfeature_scaling] <- 'both'
aris_df$regressed_out[aris_df$ncount_scaling & !aris_df$nfeature_scaling] <- 'genes_ncount'
aris_df$regressed_out[!aris_df$ncount_scaling & aris_df$nfeature_scaling] <- 'genes_nfeature'

aris_df$regressed_out <- factor(aris_df$regressed_out,
                                   levels = c('none', 'genes_ncount', 'genes_nfeature', 'both'))

```

```{r, fig.width=12, fig.height=8, results = 'asis'}

aris_df$label1 <- sprintf('res%s_(n=%s)', aris_df$res1, aris_df$size1)
aris_df$label2 <- sprintf('res%s_(n=%s)', aris_df$res2, aris_df$size2)

cat('### genes vs repeats cr\n\n')

print(ggplot(aris_df[aris_df$id1 == 'genes' & aris_df$id2 == 'repeats_cr',],
             aes(x = res1, y = ari, col = as.factor(regressed_out))) +
      geom_point() +
      labs(title = "genes cellranger vs repeats cellranger (from repeats bam)",
           subtitle = "by repeats resolution", y = "ARI", x = "genes resolution",
           color = 'regressed out') +
      facet_grid(sample~paste0('repeats res.\n', res2)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)))

cat('\n\n')

cat('### genes vs repeats fc\n\n')

print(ggplot(aris_df[aris_df$id1 == 'genes' & aris_df$id2 == 'repeats_fc',],
             aes(x = res1, y = ari, col = as.factor(regressed_out))) +
      geom_point() +
      labs(title = "genes cellranger vs repeats featurecounts (from genes bam)",
           subtitle = "by repeats resolution", y = "ARI", x = "genes resolution",
           color = 'regressed out') +
      facet_grid(sample~paste0('repeats res.\n', res2)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)))

cat('\n\n')

cat('### repeats fc vs repeats cr\n\n')

print(ggplot(aris_df[aris_df$id1 == 'repeats_fc' & aris_df$id2 == 'repeats_cr',],
             aes(x = res1, y = ari, col = as.factor(regressed_out))) +
      geom_point() +
      labs(title = "repeats featurecounts (from genes bam) vs repeats cellranger (repeats bam)",
           subtitle = "by repeats cellranger resolution", y = "ARI", x = "repeats fc resolution",
           color = 'regressed out') +
      facet_grid(sample~paste0('repeats cr res.\n', res2)) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)))

cat('\n\n')
```


Maybe add the number of clusters? as a size param?


Rather, plot both size and res

```{r, eval = TRUE}
## print(ggplot(aris_df[aris_df$id1 == 'repeats_fc' & aris_df$id2 == 'repeats_cr',],
##              aes(x = res1, y = ari, col = as.factor(regressed_out))) +
##       geom_point() +
##       labs(title = "repeats featurecounts (from genes bam) vs repeats cellranger (repeats bam)",
##            subtitle = "by repeats cellranger resolution", y = "ARI", x = "repeats fc resolution",
##            color = 'regressed out') +
##       facet_grid(sample~paste0('repeats cr res.\n', res2)) +
##       theme(axis.text.x = element_text(angle = 90, hjust = 1)))

print(ggplot(aris_df,
             aes(x = res1, y = size1, col = as.factor(regressed_out))) +
      geom_point() +
      facet_grid(sample~id1) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)))

print(ggplot(aris_df,
             aes(x = res2, y = size2, col = as.factor(regressed_out))) +
      geom_point() +
      facet_grid(sample~id2) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)))
```

# All variable features and all repeats methods at once, using scina {.tabset}

## With repeats including control not overlapping genes

```{r}

NCELLS = 200 ## cells per run:sample
NVARIABLE = 20 ## variable repeats features (per run:sample)

cr <- list()
for (flavour in c('repeats_cellranger', 'repeats_star', 'repeats_featurecounts',
                  'control_repeats_only')) {
    for (run in names(d)[sapply(d, function(x) return(flavour %in% names(x)))]) {

        cr[[paste(flavour, run)]] <- data.frame(
            rep = head(VariableFeatures(d[[run]][[flavour]]), NVARIABLE),
            flavour = flavour,
            run = run,
            stringsAsFactors = FALSE)
    }    
}

cr <- do.call(rbind.data.frame, cr)
table(cr$flavour, cr$run)

variable <- list()
for (flavour in c('repeats_cellranger', 'repeats_star', 'repeats_featurecounts', 'control_repeats_only')) {
    for (run in names(d)[sapply(d, function(x) return(flavour %in% names(x)))]) {
        idx <- sample(colnames(d[[run]][[flavour]]), size = NCELLS, replace = FALSE)
        variable[[paste(run, flavour, sep = '.')]] <- GetAssayData(d[[run]][[flavour]],
                            slot = 'data')[unique(cr$rep),idx]
    }
}

foo <- do.call(cbind.data.frame, variable)

colannot <- data.frame(id = colnames(foo),
                       sample = sapply(strsplit(colnames(foo), '.', fixed = TRUE),
                                        function(x) return(x[1])),
                       flavour = sapply(strsplit(colnames(foo), '.', fixed = TRUE),
                                       function(x) return(x[2])),
                       cell = sapply(strsplit(colnames(foo), '.', fixed = TRUE),
                                     function(x) return(x[3])),
                       scina = NA,
                       stringsAsFactors = FALSE)


head(colannot)

for ( i in 1:nrow(colannot)) {
    colannot[i, 'scina'] <- as.character(d[[colannot[i, 'sample']]][[colannot[i, 'flavour']]]@meta.data[colannot[i, 'cell'], 'scina'])

    
}

rownames(colannot) <- colannot$id

table(colannot$scina)


## remove any repeat whose annotation by scina is 'unknown'
colannot <- colannot[colannot$scina != 'unknown',]
foo <- foo[,colannot$id]
dim(foo)

## remove any repeat with 0 sd after sampling
sum(is.infinite(unlist(foo)))
foo <- foo[apply(foo, 1, sd) > 0,]

```

```{r, fig.height = 20, fig.width = 20}


newCols <- colorRampPalette(grDevices::rainbow(length(unique(colannot$scina))))
mycolors <- newCols(length(unique(colannot$scina)))
names(mycolors) <- unique(colannot$scina)
mycolors <- list(scina = mycolors)

print(pheatmap(foo,
               color = viridis(100),
            cluster_rows = TRUE,
            cluster_cols = TRUE,
            show_rownames = TRUE,
            show_colnames = FALSE,
            clustering_distance_cols = "euclidean",
            clustering_method = "ward.D2",
            clustering_distance_rows = "euclidean",
            fontsize_row = 12,
            annotation_col = colannot[,c('flavour', 'sample', 'scina')],
            annotation_colors = mycolors,
            scale = "none"))



```

## Without non-overlapping genes repeats control (biased by transcriptome)

```{r}

NCELLS = 200 ## cells per run:sample
NVARIABLE = 20 ## variable repeats features (per run:sample)

cr <- list()
for (flavour in c('repeats_cellranger', 'repeats_star', 'repeats_featurecounts')) {
    for (run in names(d)[sapply(d, function(x) return(flavour %in% names(x)))]) {

        cr[[paste(flavour, run)]] <- data.frame(
            rep = head(VariableFeatures(d[[run]][[flavour]]), NVARIABLE),
            flavour = flavour,
            run = run,
            stringsAsFactors = FALSE)
    }    
}

cr <- do.call(rbind.data.frame, cr)
table(cr$flavour, cr$run)

variable <- list()
for (flavour in c('repeats_cellranger', 'repeats_star', 'repeats_featurecounts')) {
    for (run in names(d)[sapply(d, function(x) return(flavour %in% names(x)))]) {
        idx <- sample(colnames(d[[run]][[flavour]]), size = NCELLS, replace = FALSE)
        variable[[paste(run, flavour, sep = '.')]] <- GetAssayData(d[[run]][[flavour]],
                            slot = 'data')[unique(cr$rep),idx]
    }
}

foo <- do.call(cbind.data.frame, variable)

colannot <- data.frame(id = colnames(foo),
                       sample = sapply(strsplit(colnames(foo), '.', fixed = TRUE),
                                        function(x) return(x[1])),
                       flavour = sapply(strsplit(colnames(foo), '.', fixed = TRUE),
                                       function(x) return(x[2])),
                       cell = sapply(strsplit(colnames(foo), '.', fixed = TRUE),
                                     function(x) return(x[3])),
                       scina = NA,
                       stringsAsFactors = FALSE)


head(colannot)

for ( i in 1:nrow(colannot)) {
    colannot[i, 'scina'] <- as.character(d[[colannot[i, 'sample']]][[colannot[i, 'flavour']]]@meta.data[colannot[i, 'cell'], 'scina'])

    
}

rownames(colannot) <- colannot$id

table(colannot$scina)


## remove any repeat whose annotation by scina is 'unknown'
colannot <- colannot[colannot$scina != 'unknown',]
foo <- foo[,colannot$id]
dim(foo)

## remove any repeat with 0 sd after sampling
sum(is.infinite(unlist(foo)))
foo <- foo[apply(foo, 1, sd) > 0,]

```

```{r, fig.height = 20, fig.width = 20}


newCols <- colorRampPalette(grDevices::rainbow(length(unique(colannot$scina))))
mycolors <- newCols(length(unique(colannot$scina)))
names(mycolors) <- unique(colannot$scina)
mycolors <- list(scina = mycolors)

print(pheatmap(foo,
               color = viridis(100),
            cluster_rows = TRUE,
            cluster_cols = TRUE,
            show_rownames = TRUE,
            show_colnames = FALSE,
            clustering_distance_cols = "euclidean",
            clustering_method = "ward.D2",
            clustering_distance_rows = "euclidean",
            fontsize_row = 12,
            annotation_col = colannot[,c('flavour', 'sample', 'scina')],
            annotation_colors = mycolors,
            scale = "none"))



```

# Timestamp

```{r sessionInfo, cache = FALSE}
date()
sessionInfo()
devtools::session_info()

```

