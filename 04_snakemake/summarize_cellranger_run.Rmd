---
title: "test"
author: "Izaskun Mallona"
output:
  html_document:
    keep_md: false
    toc: true
    toc_float: true
    toc_depth: 4
params:
  genes_gz: ""
  repeats_gz: ""
---

Rather, try to read snakemake params

Render with rmarkdown::render("summarize_cellranger_run.Rmd")

, params = list(myName = "here"))



```{r}
print(params)
```

```{r}
print(sessionInfo())
```

# Config

```{r}
library(Matrix)

library(knitr)
library(Seurat)
library(dplyr)
## library(scater)
library(dplyr)
## library(data.table)
## library(SingleCellExperiment)
## library(scran)
## library(org.Mm.eg.db)
## suppressPackageStartupMessages(library(dplyr))
## suppressPackageStartupMessages(library(DT))
## library(pheatmap)
## library(Cairo)
## library(RColorBrewer)
## library(corrplot)
library(ggplot2)
library(reshape2)
## library(xtable)
library(mclust)
library(pheatmap)
```

```{r}
opts_chunk$set(fig.width = 8,
               fig.height = 8,
               cache = TRUE,
               include = TRUE,
               cache.lazy = FALSE,
               warning = TRUE,
               message = TRUE)


options(bitmapType='cairo')
getOption('bitmapType')
```


## Functions

```{r functions}
## add alpha
ac <- function(col, alpha=1){
  apply(sapply(col, col2rgb)/255, 2, 
                     function(x) 
                       rgb(x[1], x[2], x[3], alpha=alpha))  
}

```

# Data load


```{r}
d <- list()
```

Genes data read

```{r genes, eval = FALSE}

barcodes_fn <- snakemake@input[[1]] ## should end with `barcodes.tsv.gz`
path <- dirname(barcodes_fn)

features_fn <- file.path(path, "features.tsv.gz")
matrix_fn <- file.path(path, "matrix.mtx.gz")

d$genes <- readMM(file = matrix_fn)

colnames(d$genes) = read.delim(barcodes_fn, 
                           header = FALSE,
                           stringsAsFactors = FALSE)$V1

rownames(d$genes) = read.delim(features_fn, 
                           header = FALSE,
                           stringsAsFactors = FALSE)$V1

print(dim(d$genes))

```


```{r}
barcodes_fn <- params$genes_gz ## should end with `barcodes.tsv.gz`
path <- dirname(barcodes_fn)

d$genes <- CreateSeuratObject(counts = Read10X(data.dir = path),
                                project = 'seurat',
                                min.cells = 1,
                                min.features = 10)
```


Repeats data read

```{r repeats, eval = FALSE}

barcodes_fn <- params$repeats_gz ## should end with `barcodes.tsv.gz`
path <- dirname(barcodes_fn)

features_fn <- file.path(path, "features.tsv.gz")
matrix_fn <- file.path(path, "matrix.mtx.gz")

d$repeats <- readMM(file = matrix_fn)

colnames(d$repeats) = read.delim(barcodes_fn, 
                           header = FALSE,
                           stringsAsFactors = FALSE)$V1

rownames(d$repeats) = read.delim(features_fn, 
                           header = FALSE,
                           stringsAsFactors = FALSE)$V1

print(dim(d$repeats))
```


```{r}
barcodes_fn <- params$repeats_gz ## should end with `barcodes.tsv.gz`
path <- dirname(barcodes_fn)

d$repeats <- CreateSeuratObject(counts = Read10X(data.dir = path),
                                project = 'seurat',
                                min.cells = 1,
                                min.features = 10)

```

# Basic Seurat processing

```{r, message = FALSE}
for (item in names(d)) {

    d[[item]] <- FindVariableFeatures(d[[item]], selection.method = "vst", nfeatures = 2000)

                                        # Identify the 10 most highly variable genes
    top10 <- head(VariableFeatures(d[[item]]), 10)

                                        # plot variable features with and without labels
    plot1 <- VariableFeaturePlot(d[[item]])
    plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
    print(CombinePlots(plots = list(plot1, plot2)))
    
}
```

```{r, message = FALSE}
NUM_PCS <- 1:20
for (item in names(d)) {

    d[[item]] <- ScaleData(d[[item]])

    d[[item]] <- RunPCA(d[[item]], features = VariableFeatures(object = d[[item]]))

    DimPlot(d[[item]], reduction = "pca")

    ElbowPlot(d[[item]])

    d[[item]] <- FindNeighbors(d[[item]], dims = NUM_PCS)
    for (res in seq(0.2, 2, by = 0.2)) {
        d[[item]] <- FindClusters(d[[item]], resolution = res)

    }

    d[[item]] <- RunUMAP(d[[item]], dims = NUM_PCS)
        
    p1 <- DimPlot(d[[item]], reduction = "umap")
        
    d[[item]] <- RunTSNE(d[[item]], dims = NUM_PCS)
        
    p2 <- DimPlot(d[[item]], reduction = "tsne")

    print(CombinePlots(plots = list(p1, p2)))

}


```

# Confusion matrix clusters

At a given resolution, compare both clusterings

ARIs versus literate identity as annotated by Olivia.

This comparison is not really fair because some integrations have less data than others. Color scale depicts Rand Index.

```{r, results = 'asis', fig.width = 4, fig.height = 4, cache = FALSE}
aris <- list()
i <- 1
for (genes_res in seq(0.2, 2, 0.2)) {
    genes_res <- sprintf('RNA_snn_res.%s', genes_res)
    
    for (repeats_res in seq(0.2, 2, 0.2)) {
        repeats_res <- sprintf('RNA_snn_res.%s', repeats_res)

        cells <- intersect(rownames(d$genes@meta.data), rownames(d$repeats@meta.data))
        
   

        aris[[i]] <- c(sprintf('genes_%s', genes_res),
                       sprintf('repeats_%s', repeats_res),
                       adjustedRandIndex(d$genes@meta.data[cells,genes_res],
                                         d$repeats@meta.data[cells,repeats_res]))
        i <- i +1
    }    
}

aris <- do.call(rbind.data.frame, aris)
colnames(aris) <- c('genes_res', 'repeats_res', 'ari')
aris$ari <- as.numeric(as.character(aris$ari))
```


```{r}
aris_wide <- reshape2::dcast(aris, genes_res~repeats_res, value.var="ari")

rownames(aris_wide)<- aris_wide$genes_res
aris_wide <- aris_wide[,-1]

pheatmap(aris_wide, cluster_rows = FALSE, cluster_cols = FALSE,
         color = colorRampPalette(c("white","blue"))(20))
```



# Timestamp

```{r sessionInfo, cache = FALSE}
date()
sessionInfo()
devtools::session_info()

```

